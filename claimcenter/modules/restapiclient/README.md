# Overview

This project has two components:

* **REST API Client Generator**: Generates java code based on an openapi definition file and packages it together with the REST API Client Library for use in an InsuranceSuite application.
* **REST API Client Library**: Provides utilities to support writing code to invoke REST API classes with fault-tolerance. This can be used to invoke classes generated by the REST API Client Generator.

# REST API Client Generator

## Overview

This project generates API clients from an openapi definition. The client can be installed into an InsuranceSuite application.

## Configuration

Before starting, add the project to a source control repository to track changes to configuration files and generated code.

To generate the client, first, edit the following files to configure the desired APIs. The files are initially populated with some example values. If you wish to only experiment with the REST API Client Generator, you may skip to the Gradle Tasks step.

### build.gradle

Configure properties `gwRestGen_<apiname>_source` and `gwRestGen_<apiname>_package`. `gwRestGen_<apiname>_source` can be a URL or a path to a local file (relative to the project root directory). Do not modify `gwRestGen_isInsuranceSuite`.

### settings.gradle

Add an `include` statement with the name of your API.

### Example: One API called "endpoint"

This is the example with which the project is initially configured.

#### build.gradle

```
version = "1.0.0"
...
ext {
  gwRestGen_endpoint_package = "petstore"
  gwRestGen_endpoint_source = "https://petstore.swagger.io/v2/swagger.json"
  gwRestGen_isInsuranceSuite = "true"
}
apply plugin: 'com.guidewire.restclient.codegen'
```

#### settings.gradle

```
include 'endpoint'
```

### Example: Multiple APIs

#### build.gradle

```
version = "1.1.0-SNAPSHOT"
...
ext {
  gwRestGen_cc_v1_package = "cc.v1"
  // lets capture it in the jar
  gwRestGen_cc_v1_source = "cc/v1/src/main/resources/openapi.json"
  gwRestGen_pl_v1_package = "pl.v1"
  // lets capture it in the jar
  gwRestGen_pl_v1_source = "pl/v1/src/main/resources/openapi.json"
  gwRestGen_isInsuranceSuite = "true"
}
apply plugin: 'com.guidewire.restclient.codegen'
```

#### settings.gradle

```
include 'cc:v1'
include 'pl:v1'
```

## Gradle Tasks

### Typical Usage

Use the Gradle tasks to prepare the client. These are the typical steps:
1. Run `restDownload` (if `gwRestGen_<apiname>_source` specifies a URL) or `restCodegen` (if it specifies a local path)
2. Make any manual edits to the generated java code
3. Run `build` and `publish`
4. Unzip the file from `build/distribution` into the InsuranceSuite app's `modules/configuration/plugins/shared/lib` directory.

Gradle commands can be run from the command line in the project root directory (e.g., `./gradlew build`), or some may be available from IntelliJ's Gradle panel under the "guidewire rest client" group.

If you make manual edits to the generated java code (step #2), add a pattern in the corresponding .openapi-generator-ignore file to prevent them from being overwritten during later codegen, but note that they will no longer be updated with openapi definition changes.

### Task Reference

#### `restDownload`

Only available if `gwRestGen_<apiname>_source` is a URL.
Downloads the openapi definition from the URL in `gwRestGen_<apiname>_source` and stores the result in the directory for the corresponding API.
It then triggers `restCodegen`, which generates the client java code.

#### `restCodegen`

Triggers `restConfig`, then runs the openapi code generator. This may also trigger `build` if the API directory already existed.

#### `restConfig`

Creates codegen.config.yaml in each API directory. This file controls the codegen process. This task will not overwrite the file if it already exists. Most implementations do not modify this file.
This task then triggers `restCodegen`.

#### `build`

Compiles the java code and creates a jarfile in the build directory for inclusion in the zipfile.

#### `publish`

Packages all of the libraries (both libs and generated code) into a zipfile in the build directory.
Note: If `build` has not been run, `package` may run successfully but produce a zip file without the generated client code.

#### `copy`

Copies jarfiles from the lib directory into build for inclusion in the zipfile. The lib directory includes the REST API Client Library. Triggered by `build`.

#### `copyCompileLibs`

Copies jarfiles from the compile-libs directory for inclusion in the zipfile. These jars are present in InsuranceSuite, so this task is not always needed and is not triggered by `build` or `publish`.

#### `wrap`

Sets up the gradle project. This step is performed automatically if the project is initially opened in IntelliJ.

## Testing

### Testing with InsuranceSuite

After extracting the zipfile into `modules/configuration/plugins/shared/lib` in InsuranceSuite, you can create some simple tests.

This example actually hits the endpoint, so a test like this shouldn't be committed as it will be run every time you build insurance suite.
```
package gw.servertest
uses gw.api.test.CCServerTestClassBase
uses gw.restclient.config.Config
uses gwgen.petstore.ApiClient
uses gwgen.petstore.api.StoreApi

class PetStoreApiTest extends CCServerTestClassBase {
  function testGetInventory() {
    var api = Config.builder().basePath(ApiClient.BASE_PATH).build().buildAPI(StoreApi)
    var inv = api.getInventory()
    inv.forEach( \ key, cnt -> print("{key} = {cnt}\n"))
  }
}
```

# REST API Client Library

## Overview
This library is used to make REST API calls using Guidewire's best practices. It provides the following fault tolerance features:
* Retry
* Circuit Breaker
* Fallback
* Timeout

## How do I use this?
The library's API follows the functional programming paradigm along with the Decorator pattern to construct a set of features around REST calls.

## Examples

These examples use the StoreApi from the Petstore REST services.

### REST call with default set of fault tolerance parameters
```
import gw.restclient.config.Config;

Map<String, Integer> response = Config.builder().build()
  .buildAPI(StoreApi.class)
  .getInventory();
```

### REST call with custom fault tolerance parameters
```
Map<String, Integer> response = Config.builder()
  .eventHandler(RetrySetup.builder()
    .maxAttempt(5)
    .build())
  .build()
  .buildAPI(StoreApi.class)
  .getInventory();
```

### Externalizing RestClient configuration
The RestClient configuration parameters can be externalized and retrieved using a Config object via JSON.
```
    String configString = configProvider.get("myapp.myendpoint.config");
    Config config = Config.parseYaml(configString).build();
    Map<String, Integer> response = config.buildAPI(StoreApi.class)
      .getInventory();
```

### Order of fault tolerance decorators matters
In the following example, a fallback is wrapped within a retry because the fallback is defined first.
```
Config config = Config.builder()
  .eventHandler(FallbackSetup.builder()
    .exceptionType(Throwable.class)
    .exceptionHandler(throwable -> Collections.emptyMap())
    .build())
  .eventHandler(RetrySetup.builder()
    // Even though maxAttempt is 5, only one retry attempt will ever be made because the fallback handler
    // will always successfully return an emtpy map for any Throwable.
    .maxAttempt(5)
    .build())
  .build();
  .buildAPI(StoreApi.class)
  .getInventory();
```

## Fault Tolerance
The REST Client includes a set of fault tolerance features that can be applied to a REST call.

### Retry
This is used to retry executing a piece of code multiple times if a particular type of exception is thrown.

#### Configurations
| Setup property            | Default value                     | Description                                                                                                                                         |
|---------------------------|-----------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| maxAttempts               | 3                                 | The maximum number of attempts before failing                                                                                                       |
| exponentialBackoff        | none                              | An exponential backoff function to modify the waiting interval after each failure; If not specified, the "intervalFunction" is used.                |
| intervalFunction          | always returns 500ms              | A function to modify the waiting interval after a failure                                                                                           |
| retryOnResultPredicate    | always false for any result value | A predicate determining if a result should be retried; It must return true, if the result should be retried, otherwise it must return false.        |
| retryOnExceptionPredicate | always true for any Throwable     | A predicate determining if an exception should be retried; It must return true, if the exception should be retried, otherwise it must return false. |
```
Config config = Config.builder()
  .eventHandler(RetrySetup.builder()
    .retryOnResultPredicate(Objects::nonNull)
    .retryOnExceptionPredicate(e -> e instanceof IOException)
    .maxAttempts(7)
    .build();
```

#### Multiple retry attempts specified
Specifying multiple retries would result in wrapping around a retry within another retry.
```
Config config = Config.builder()
  .eventHandler(RetrySetup.builder().maxAttempts(5).build());
  .eventHandler(RetrySetup.builder().maxAttempts(2).build());
  .build();  // This results in executing the throw statement 10 times.
```

### Circuit Breaker
This is used to invoke a circuit breaker when api calls have failed or are deemed to be slow. The Circuit breaker will start short-circuiting api calls when a failure rate or slow call rate threshold is reached.
A circuit breaker instance is used by multiple REST calls to determine the state of the circuit breaker. An instance is uniquely identifiable by its name within a JVM.

#### States
| State                 | Description                                                                                                                                                                                                                                                                                |
|-----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| CLOSED                | The starting state for circuit breaker, failure rate or slow call rate threshold will be calculated.                                                                                                                                                                                       |
| OPEN                  | Circuit breaker will transition to this state once the failure rate or the slow call rate threshold is reached. No API calls will be executed. Transition to HALF-OPEN state once wait interval has elapsed.                                                                               |
| HALF-OPEN             | Permits a configurable number of calls to see if the backend is still unavailable or has become available again. Once wait interval has elapsed, it will transition to CLOSED state when failure rate or slow call rate is below threshold. Otherwise, it will transition to OPEN state.   |

#### Configurations
| Setup property                                  | Default value                     | Description                                                                                                                                                     |
|-------------------------------------------------|-----------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| failureRateThreshold                            | 50                                | Configures the failure rate threshold in percentage.                                                                                                            |
| slowCallRateThreshold                           | 100                               | Configures the slow call rate threshold in percentage.                                                                                                                           |
| slowCallDurationThreshold                       | 60000ms                           | Configures the duration threshold above which calls are considered as slow and increase the rate of slow calls.                                                 |
| permittedNumberOfCallsInHalfOpenState           | 10	                              | Configures the number of permitted calls when the CircuitBreaker is half open.                                                                                  |
| slidingWindowType                               | COUNT_BASED                       | Configures the type of the sliding window which is used to record the outcome of calls when the CircuitBreaker is closed.                                       |
| slidingWindowSize                               | 100                               | Configures the size of the sliding window which is used to record the outcome of calls.                                                                         |
| minimumNumberOfCalls                            | 100                               | Configures the minimum number of calls which are required (per sliding window period) before the CircuitBreaker can calculate the error rate or slow call rate. |
| automaticTransitionFromOpenToHalfOpenEnabled    | false                             | If set to true it means that the CircuitBreaker will automatically transition from open to half-open state and no call is needed to trigger the transition.     |
| waitIntervalFunctionInOpenState                 | always returns 500ms              | A function to modify the waiting interval in open state (when circuit breaker short-circuiting the calls).                                                      |
| writableStackTraceEnabled                       | true                              | Enables writable stack traces. Set to false to reduce log spam when the circuit breaker is open as the cause of the exceptions is already known.                |
| recordException                                 | always false for any exceptions   | A predicate determining if an exception should be recorded; It must return true, if the exception should be recorded, otherwise it must return false.           |

#### Define circuit breaker with default name and configurations
````
Config config = Config.builder()
  .eventHandler(CircuitBreakerSetup.builder().build());  // default name is GW_CIRCUITBREAKER
  .build();
````

#### Define circuit breaker with custom name and configurations
````
Config config = Config.builder()
  .eventHandler(CircuitBreakerSetup.builder()
    .name("customeCircuitBreakerName")
    .failureRateThreshold(50)
    .slowCallRateThreshold(100)
    .slowCallDurationThreshold(Duration.ofMillis(60000))
    .permittedNumberOfCallsInHalfOpenState(10)
    .slidingWindowType(CircuitBreakerSetup.SlidingWindowType.COUNT_BASED)
    .slidingWindowSize(100)
    .minimumNumberOfCalls(100)
    .waitIntervalFunctionInOpenState(x -> 500L)
    .automaticTransitionFromOpenToHalfOpenEnabled(false)
    .recordException(e -> e instanceof IOException)
    .writableStackTraceEnabled(true)
    .build())
  .build();
````

### Fallback
This is used to recover from an exception by returning a specific value.
```
Config config = Config.builder()
  .eventHandler(FallbackSetup.builder()
    .exceptionType(IOException.class)
    .exceptionHandler(e -> "fallback") // This results in returning the String "fallback".
    .build())
  .build();
```

### Timeout
Because Timeout is
This is used to set a timeout for the specified piece of code to execute.
```
Config config = Config.builder()
  .timeout(TimeoutSetup.builder()
    .connectTimeoutMillis(1000)
    .readTimeoutMillis(500)
    .build())
  .build();
```

## API Security
The REST client includes several API Authentication methods which can be easily configured for your API calls.
The supported authentication methods are Basic, Api Key, Bearer and OAuth 2.0.

### Basic Authentication Configuration
````
Config config = Config.builder()
    .auth(HttpBasicAuth.builder()
      .username("user")
      .password("password")
      .build())
    .build();
````

### API Key Authentication Configuration
````
Config config = Config.builder()
  .auth(ApiKeyAuth.builder()
    .apiKey("key")
    .location(ApiKeyAuth.Location.header)
    .paramName("ApiKey")
    .build())
  .build();
````

### Bearer Authentication Configuration
````
Config config = Config.builder()
  .auth(HttpBearerAuth.builder()
    .bearerToken("tokenValue")
    .scheme("Bearer")
    .build())
  .build();
````

### OAuth 2.0 Configuration
#### Client Credentials Flow
````
Config config = Config.builder()
  .auth(OAuth.builder()
    .tokenUrl("tokenUrl")
    .scopes("scope1 scope2")
    .flow(OAuth.OAuthFlow.application)
    .tokenStore(new OAuthTokenStore.Default())
    .credentials(OAuthCredentials.builder()
      .clientId("clientId")
      .clientSecret("clientSecret")
      .build())
    .build())
  .build();
````

#### Password Flow
````
Config config = Config.builder()
  .auth(OAuth.builder()
    .tokenUrl("tokenUrl")
    .scopes("openid")
    .flow(OAuth.OAuthFlow.password)
    .tokenStore(new OAuthTokenStore.Default())
    .credentials(OAuthCredentials.builder()
      .clientId("clientId")
      .clientSecret("clientSecret")
      .username("username")
      .password("password")
      .build())
    .build())
  .build();
````

## Mutual TLS
The REST client supports two-way authentication which can be configured via the config object
````
Config config = Config.builder()
  .basePath(basePath)
  .ssl(SSLSetup.builder()
    .socketFactory()
    .hostnameVerifier()
    .build())
  .build();
````

## Adding Interceptors
This interceptor will forward tracing values from MDC to headers if they have not been set previously
````
Config config = Config.builder()
  .requestInterceptor(new ForwardingInterceptor(Action implementation))
  .build();
````

## Adding Decoders
Custom decoders can be used in construction of the Feign client. To use the custom decorders, caller needs to configure OpenFeign's ApiClient class directly.
````
Bank bankAPI = Feign.builder()
  .decoder(nestingContextDecoder)
  .target(Bank.class, "https://api.examplebank.com");
Bank restClientBankAPI = RestClient.of(bankAPI, new RestClientDecoratorFactory());
restClientBankAPI.createAccount(ssn);
````
